/* eslint-disable @typescript-eslint/no-explicit-any */
import { DOCUMENT } from '@angular/common';
import { Inject, Injectable, InjectionToken, Optional } from '@angular/core';
import { of } from 'rxjs';
import { concatMap } from 'rxjs/operators';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
import * as i2 from "../normalize-url/normalize-url.service";
export const EMBEDDED_DATA_SERVICE_CONFIG_TOKEN = new InjectionToken('EMBEDDED_DATA_SERVICE_CONFIG_TOKEN');
export function getLocaleId(embeddedDataService) {
    return embeddedDataService.LocaleId;
}
export class EmbeddedDataService {
    get ContextConfiguration() {
        if (typeof this._contextConfiguration === 'undefined') {
            this._contextConfiguration = this.parseAttribute(this._serviceConfig.ContextConfigurationAttribute);
        }
        return this._contextConfiguration;
    }
    get CustomConfiguration() {
        if (typeof this._customConfiguration === 'undefined') {
            this._customConfiguration = Object.assign({}, this._serviceConfig.DefaultCustomConfiguration, this.parseAttribute(this._serviceConfig.CustomConfigurationAttribute));
        }
        return this._customConfiguration;
    }
    get I18n() {
        if (typeof this._i18n === 'undefined') {
            this._i18n = this.parseAttribute(this._serviceConfig.I18nAttribute);
        }
        return this._i18n;
    }
    get Caas() {
        if (typeof this._caas === 'undefined') {
            this._caas = this.parseAttribute(this._serviceConfig.CaaSAttribute);
        }
        return this._caas;
    }
    get Language() {
        if (this.ContextConfiguration && this.ContextConfiguration.language) {
            return this.ContextConfiguration.language;
        }
        return this._documentLocale && this._documentLocale.language ? this._documentLocale.language : this._serviceConfig.LanguageDefault;
    }
    get Country() {
        if (this.ContextConfiguration && this.ContextConfiguration.country) {
            return this.ContextConfiguration.country;
        }
        return this._documentLocale && this._documentLocale.country ? this._documentLocale.country : this._serviceConfig.CountryDefault;
    }
    get LocaleId() {
        return this.Language + '-' + this.Country;
    }
    get InstanceId() {
        return this.CustomConfiguration.instanceId;
    }
    get embeddedDataServiceConfig() {
        return this._serviceConfig;
    }
    constructor(http, normalizeUrlService, serviceConfig, document) {
        this.http = http;
        this.normalizeUrlService = normalizeUrlService;
        this.serviceConfig = serviceConfig;
        this.document = document;
        this._serviceConfig = {
            rootElementTagName: 'app',
            production: true,
            ContextConfigurationAttribute: 'contextconfiguration',
            CustomConfigurationAttribute: 'customconfiguration',
            I18nAttribute: 'i18n',
            AssetsBasePath: '/assets',
            CaaSAttribute: 'caascontent',
            LanguageDefault: 'en',
            CountryDefault: 'US',
        };
        this.findRootElement(this.document, this.serviceConfig);
        if (document && document.documentElement && document.documentElement.lang) {
            this._documentLocale = parseLocale(document.documentElement.lang);
        }
        if (serviceConfig) {
            Object.assign(this._serviceConfig, serviceConfig);
        }
    }
    findRootElement(_document, serviceConfig) {
        if (serviceConfig && serviceConfig.rootElementTagName) {
            const nativeElement = _document.getElementsByTagName(serviceConfig.rootElementTagName);
            if (nativeElement && nativeElement.length === 1) {
                this._rootElement = nativeElement[0];
                return;
            }
        }
        throw new Error('EmbeddedDataService: Root element of app could not be found!');
    }
    parseAttribute(name) {
        if (!this._rootElement) {
            throw new Error('Embedded data was not initialized!');
        }
        try {
            const attrCont = this._rootElement.getAttribute(name);
            if (attrCont.length > 0) {
                const content = JSON.parse(attrCont);
                if (!isEmpty(content)) {
                    return content;
                }
            }
        }
        catch (e) {
            if (!this._serviceConfig.production) {
                console.log('Error parsing embedded data point: ' + name);
            }
        }
        return;
    }
    /**
     * CaaS resolution logic:
     *    1. If CaaS attribute was received, use that
     *    2. If instanceId in Custom configuration, try instance config
     *    3. try global config
     * @param lang
     */
    getCaaSConfiguration() {
        // 1.
        if (this.Caas) {
            return of(this.Caas);
        }
        let ret = of(null);
        // 2.
        if (this.CustomConfiguration.instanceId) {
            ret = ret.pipe(concatMap(() => {
                return (this.http
                    .get(this.normalizeUrlService.normalizeUrl(`${this._serviceConfig.AssetsBasePath}/${this.CustomConfiguration.instanceId}/config.json`), { withCredentials: true })
                    .pipe(() => of(null)));
            }));
        }
        // 3.
        ret = ret.pipe(concatMap((prev) => {
            if (prev === null) {
                return this.http.get(this.normalizeUrlService.normalizeUrl(`${this._serviceConfig.AssetsBasePath}/config.json`), {
                    withCredentials: true,
                });
            }
            else {
                return of(prev);
            }
        }));
        return ret;
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "18.1.1", ngImport: i0, type: EmbeddedDataService, deps: [{ token: i1.HttpClient }, { token: i2.NormalizeUrlService }, { token: EMBEDDED_DATA_SERVICE_CONFIG_TOKEN, optional: true }, { token: DOCUMENT }], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "18.1.1", ngImport: i0, type: EmbeddedDataService }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "18.1.1", ngImport: i0, type: EmbeddedDataService, decorators: [{
            type: Injectable
        }], ctorParameters: () => [{ type: i1.HttpClient }, { type: i2.NormalizeUrlService }, { type: undefined, decorators: [{
                    type: Inject,
                    args: [EMBEDDED_DATA_SERVICE_CONFIG_TOKEN]
                }, {
                    type: Optional
                }] }, { type: undefined, decorators: [{
                    type: Inject,
                    args: [DOCUMENT]
                }] }] });
function isEmpty(obj) {
    for (const prop in obj) {
        if (Object.prototype.hasOwnProperty.call(obj, prop)) {
            return false;
        }
    }
    return true;
}
// http://userguide.icu-project.org/locale
function parseLocale(locale) {
    if (!locale) {
        return void 0;
    }
    // extract keyword
    const stringLocale = String(locale);
    const keywordPos = stringLocale.indexOf('@');
    const keyword = keywordPos !== -1 ? stringLocale.substr(keywordPos + 1) : void 0;
    const localeWithoutKeyword = keywordPos !== -1 ? stringLocale.substr(0, keywordPos) : stringLocale;
    // en-us => en_us
    const parts = String(localeWithoutKeyword).replace(/-/g, '_').split('_');
    if (!parts.length || parts.length > 4) {
        return void 0;
    }
    const language = parts.shift();
    if (!language) {
        return void 0;
    }
    const retVar = {
        keyword,
        language: language.toLowerCase(),
    };
    if (!parts.length) {
        return retVar;
    }
    if (parts.length === 3) {
        const variant = parts.pop();
        if (variant) {
            retVar.variant = variant.toUpperCase();
        }
    }
    let country = parts.pop();
    if (country.length > 3) {
        retVar.keyword = country;
        country = parts.pop();
    }
    if (country) {
        retVar.country = country.toUpperCase();
    }
    if (!parts.length) {
        return retVar;
    }
    const script = parts.pop();
    if (script) {
        // capitalize it.
        retVar.script = script.substr(0, 1).toUpperCase() + script.substr(1).toLowerCase();
    }
    return retVar;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW1iZWRkZWQtZGF0YS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vbGlicmFyeS9zcmMvc2VydmljZXMvZW1iZWRkZWQtZGF0YS9lbWJlZGRlZC1kYXRhLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsdURBQXVEO0FBQ3ZELE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUUzQyxPQUFPLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxjQUFjLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzdFLE9BQU8sRUFBYyxFQUFFLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDdEMsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDOzs7O0FBTTNDLE1BQU0sQ0FBQyxNQUFNLGtDQUFrQyxHQUFHLElBQUksY0FBYyxDQUE0QixvQ0FBb0MsQ0FBQyxDQUFDO0FBb0J0SSxNQUFNLFVBQVUsV0FBVyxDQUFDLG1CQUFrRDtJQUM1RSxPQUFPLG1CQUFtQixDQUFDLFFBQVEsQ0FBQztBQUN0QyxDQUFDO0FBR0QsTUFBTSxPQUFPLG1CQUFtQjtJQXFCOUIsSUFBVyxvQkFBb0I7UUFDN0IsSUFBSSxPQUFPLElBQUksQ0FBQyxxQkFBcUIsS0FBSyxXQUFXLEVBQUUsQ0FBQztZQUN0RCxJQUFJLENBQUMscUJBQXFCLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLDZCQUE2QixDQUFDLENBQUM7UUFDdEcsQ0FBQztRQUNELE9BQU8sSUFBSSxDQUFDLHFCQUFxQixDQUFDO0lBQ3BDLENBQUM7SUFHRCxJQUFXLG1CQUFtQjtRQUM1QixJQUFJLE9BQU8sSUFBSSxDQUFDLG9CQUFvQixLQUFLLFdBQVcsRUFBRSxDQUFDO1lBQ3JELElBQUksQ0FBQyxvQkFBb0IsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUN2QyxFQUFFLEVBQ0YsSUFBSSxD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Q0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQ3pDLENBQUM7SUFDSCxDQUFDO0lBRUQsSUFBSSxPQUFPLEdBQUcsS0FBSyxDQUFDLEdBQUcsRUFBRSxDQUFDO0lBQzFCLElBQUksT0FBTyxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUUsQ0FBQztRQUN2QixNQUFNLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQztRQUV6QixPQUFPLEdBQUcsS0FBSyxDQUFDLEdBQUcsRUFBRSxDQUFDO0lBQ3hCLENBQUM7SUFFRCxJQUFJLE9BQU8sRUFBRSxDQUFDO1FBQ1osTUFBTSxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUMsV0FBVyxFQUFFLENBQUM7SUFDekMsQ0FBQztJQUVELElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxFQUFFLENBQUM7UUFDbEIsT0FBTyxNQUFNLENBQUM7SUFDaEIsQ0FBQztJQUVELE1BQU0sTUFBTSxHQUFHLEtBQUssQ0FBQyxHQUFHLEVBQUUsQ0FBQztJQUMzQixJQUFJLE1BQU0sRUFBRSxDQUFDO1FBQ1gsaUJBQWlCO1FBQ2pCLE1BQU0sQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsV0FBVyxFQUFFLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxXQUFXLEVBQUUsQ0FBQztJQUNyRixDQUFDO0lBRUQsT0FBTyxNQUFNLENBQUM7QUFDaEIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qIGVzbGludC1kaXNhYmxlIEB0eXBlc2NyaXB0LWVzbGludC9uby1leHBsaWNpdC1hbnkgKi9cbmltcG9ydCB7IERPQ1VNRU5UIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uJztcbmltcG9ydCB7IEh0dHBDbGllbnQgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5pbXBvcnQgeyBJbmplY3QsIEluamVjdGFibGUsIEluamVjdGlvblRva2VuLCBPcHRpb25hbCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgb2YgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGNvbmNhdE1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IE5vcm1hbGl6ZVVybFNlcnZpY2UgfSBmcm9tICcuLi9ub3JtYWxpemUtdXJsL25vcm1hbGl6ZS11cmwuc2VydmljZSc7XG5pbXBvcnQgeyBDb250ZXh0Q29uZmlndXJhdGlvbkJhc2UgfSBmcm9tICcuL2NvbnRleHQtY29uZmlnLWJhc2UuaW50ZXJmYWNlJztcbmltcG9ydCB7IEN1c3RvbUNvbmZpZ3VyYXRpb25CYXNlIH0gZnJvbSAnLi9jdXN0b20tY29uZmlnLWJhc2UuaW50ZXJmYWNlJztcbmltcG9ydCB7IEVtYmVkZGVkRGF0YVNlcnZpY2VJbnRlcmZhY2UgfSBmcm9tICcuL2VtYmVkZGVkLWRhdGEuc2VydmljZS5tb2RlbCc7XG5cbmV4cG9ydCBjb25zdCBFTUJFRERFRF9EQVRBX1NFUlZJQ0VfQ09ORklHX1RPS0VOID0gbmV3IEluamVjdGlvblRva2VuPEVtYmVkZGVkRGF0YVNlcnZpY2VDb25maWc+KCdFTUJFRERFRF9EQVRBX1NFUlZJQ0VfQ09ORklHX1RPS0VOJyk7XG5cbmV4cG9ydCBpbnRlcmZhY2UgRW1iZWRkZWREYXRhU2VydmljZUNvbmZpZyB7XG4gIC8qKlxuICAgKiBUaGUgdGFnIG5hbWUgb2YgdGhlIHJvb3QgZWxlbWVudC5cbiAgICogVGhpcyBpcyBjb25maWd1cmVkLCBhcyB0aGVyZSBpcyBubyB3YXkgdG8gZ2V0IHRoZSBlbGVtZW50XG4gICAqIHByb2dyYW1tYXRpY2FsbHkgZHVyaW5nIHRoZSBzZXJ2aWNlIGluaXRpYWxpemF0aW9uLlxuICAgKi9cbiAgcm9vdEVsZW1lbnRUYWdOYW1lOiBzdHJpbmc7XG4gIHByb2R1Y3Rpb24/OiBib29sZWFuO1xuICBDb250ZXh0Q29uZmlndXJhdGlvbkF0dHJpYnV0ZT86IHN0cmluZztcbiAgQ3VzdG9tQ29uZmlndXJhdGlvbkF0dHJpYnV0ZT86IHN0cmluZztcbiAgRGVmYXVsdEN1c3RvbUNvbmZpZ3VyYXRpb24/OiBDdXN0b21Db25maWd1cmF0aW9uQmFzZTtcbiAgSTE4bkF0dHJpYnV0ZT86IHN0cmluZztcbiAgQXNzZXRzQmFzZVBhdGg/OiBzdHJpbmc7XG4gIENhYVNBdHRyaWJ1dGU/OiBzdHJpbmc7XG4gIExhbmd1YWdlRGVmYXVsdD86IHN0cmluZztcbiAgQ291bnRyeURlZmF1bHQ/OiBzdHJpbmc7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRMb2NhbGVJZChlbWJlZGRlZERhdGFTZXJ2aWNlOiBFbWJlZGRlZERhdGFTZXJ2aWNlPGFueSwgYW55Pikge1xuICByZXR1cm4gZW1iZWRkZWREYXRhU2VydmljZS5Mb2NhbGVJZDtcbn1cblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIEVtYmVkZGVkRGF0YVNlcnZpY2U8XG4gIENBQVNfVCxcbiAgQ1VTVE9NX1QgZXh0ZW5kcyBDdXN0b21Db25maWd1cmF0aW9uQmFzZSA9IEN1c3RvbUNvbmZpZ3VyYXRpb25CYXNlLFxuICBDT05URVhUX1QgZXh0ZW5kcyBDb250ZXh0Q29uZmlndXJhdGlvbkJhc2UgPSBDb250ZXh0Q29uZmlndXJhdGlvbkJhc2UsXG4+IGltcGxlbWVudHMgRW1iZWRkZWREYXRhU2VydmljZUludGVyZmFjZTxDQUFTX1QsIENVU1RPTV9ULCBDT05URVhUX1Q+XG57XG4gIHByaXZhdGUgX3Jvb3RFbGVtZW50OiBhbnk7XG4gIHByaXZhdGUgX2RvY3VtZW50TG9jYWxlOiBMb2NhbGU7XG5cbiAgcHJpdmF0ZSBfc2VydmljZUNvbmZpZzogRW1iZWRkZWREYXRhU2VydmljZUNvbmZpZyA9IHtcbiAgICByb290RWxlbWVudFRhZ05hbWU6ICdhcHAnLFxuICAgIHByb2R1Y3Rpb246IHRydWUsXG4gICAgQ29udGV4dENvbmZpZ3VyYXRpb25BdHRyaWJ1dGU6ICdjb250ZXh0Y29uZmlndXJhdGlvbicsXG4gICAgQ3VzdG9tQ29uZmlndXJhdGlvbkF0dHJpYnV0ZTogJ2N1c3RvbWNvbmZpZ3VyYXRpb24nLFxuICAgIEkxOG5BdHRyaWJ1dGU6ICdpMThuJyxcbiAgICBBc3NldHNCYXNlUGF0aDogJy9hc3NldHMnLFxuICAgIENhYVNBdHRyaWJ1dGU6ICdjYWFzY29udGVudCcsXG4gICAgTGFuZ3VhZ2VEZWZhdWx0OiAnZW4nLFxuICAgIENvdW50cnlEZWZhdWx0OiAnVVMnLFxuICB9O1xuXG4gIHB1YmxpYyBnZXQgQ29udGV4dENvbmZpZ3VyYXRpb24oKTogQ09OVEVYVF9UIHtcbiAgICBpZiAodHlwZW9mIHRoaXMuX2NvbnRleHRDb25maWd1cmF0aW9uID09PSAndW5kZWZpbmVkJykge1xuICAgICAgdGhpcy5fY29udGV4dENvbmZpZ3VyYXRpb24gPSB0aGlzLnBhcnNlQXR0cmlidXRlKHRoaXMuX3NlcnZpY2VDb25maWcuQ29udGV4dENvbmZpZ3VyYXRpb25BdHRyaWJ1dGUpO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5fY29udGV4dENvbmZpZ3VyYXRpb247XG4gIH1cbiAgcHJpdmF0ZSBfY29udGV4dENvbmZpZ3VyYXRpb246IENPTlRFWFRfVDtcblxuICBwdWJsaWMgZ2V0IEN1c3RvbUNvbmZpZ3VyYXRpb24oKTogQ1VTVE9NX1Qge1xuICAgIGlmICh0eXBlb2YgdGhpcy5fY3VzdG9tQ29uZmlndXJhdGlvbiA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgIHRoaXMuX2N1c3RvbUNvbmZpZ3VyYXRpb24gPSBPYmplY3QuYXNzaWduKFxuICAgICAgICB7fSxcbiAgICAgICAgdGhpcy5fc2VydmljZUNvbmZpZy5EZWZhdWx0Q3VzdG9tQ29uZmlndXJhdGlvbixcbiAgICAgICAgdGhpcy5wYXJzZUF0dHJpYnV0ZSh0aGlzLl9zZXJ2aWNlQ29uZmlnLkN1c3RvbUNvbmZpZ3VyYXRpb25BdHRyaWJ1dGUpLFxuICAgICAgKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuX2N1c3RvbUNvbmZpZ3VyYXRpb247XG4gIH1cbiAgcHJpdmF0ZSBfY3VzdG9tQ29uZmlndXJhdGlvbjogQ1VTVE9NX1Q7XG5cbiAgcHVibGljIGdldCBJMThuKCkge1xuICAgIGlmICh0eXBlb2YgdGhpcy5faTE4biA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgIHRoaXMuX2kxOG4gPSB0aGlzLnBhcnNlQXR0cmlidXRlKHRoaXMuX3NlcnZpY2VDb25maWcuSTE4bkF0dHJpYnV0ZSk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLl9pMThuO1xuICB9XG4gIHByaXZhdGUgX2kxOG47XG5cbiAgcHVibGljIGdldCBDYWFzKCkge1xuICAgIGlmICh0eXBlb2YgdGhpcy5fY2FhcyA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgIHRoaXMuX2NhYXMgPSB0aGlzLnBhcnNlQXR0cmlidXRlKHRoaXMuX3NlcnZpY2VDb25maWcuQ2FhU0F0dHJpYnV0ZSk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLl9jYWFzO1xuICB9XG4gIHByaXZhdGUgX2NhYXM7XG5cbiAgcHVibGljIGdldCBMYW5ndWFnZSgpOiBzdHJpbmcge1xuICAgIGlmICh0aGlzLkNvbnRleHRDb25maWd1cmF0aW9uICYmIHRoaXMuQ29udGV4dENvbmZpZ3VyYXRpb24ubGFuZ3VhZ2UpIHtcbiAgICAgIHJldHVybiB0aGlzLkNvbnRleHRDb25maWd1cmF0aW9uLmxhbmd1YWdlO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLl9kb2N1bWVudExvY2FsZSAmJiB0aGlzLl9kb2N1bWVudExvY2FsZS5sYW5ndWFnZSA/IHRoaXMuX2RvY3VtZW50TG9jYWxlLmxhbmd1YWdlIDogdGhpcy5fc2VydmljZUNvbmZpZy5MYW5ndWFnZURlZmF1bHQ7XG4gIH1cblxuICBwdWJsaWMgZ2V0IENvdW50cnkoKTogc3RyaW5nIHtcbiAgICBpZiAodGhpcy5Db250ZXh0Q29uZmlndXJhdGlvbiAmJiB0aGlzLkNvbnRleHRDb25maWd1cmF0aW9uLmNvdW50cnkpIHtcbiAgICAgIHJldHVybiB0aGlzLkNvbnRleHRDb25maWd1cmF0aW9uLmNvdW50cnk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMuX2RvY3VtZW50TG9jYWxlICYmIHRoaXMuX2RvY3VtZW50TG9jYWxlLmNvdW50cnkgPyB0aGlzLl9kb2N1bWVudExvY2FsZS5jb3VudHJ5IDogdGhpcy5fc2VydmljZUNvbmZpZy5Db3VudHJ5RGVmYXVsdDtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgTG9jYWxlSWQoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5MYW5ndWFnZSArICctJyArIHRoaXMuQ291bnRyeTtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgSW5zdGFuY2VJZCgpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLkN1c3RvbUNvbmZpZ3VyYXRpb24uaW5zdGFuY2VJZDtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgZW1iZWRkZWREYXRhU2VydmljZUNvbmZpZygpOiBFbWJlZGRlZERhdGFTZXJ2aWNlQ29uZmlnIHtcbiAgICByZXR1cm4gdGhpcy5fc2VydmljZUNvbmZpZztcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgaHR0cDogSHR0cENsaWVudCxcbiAgICBwcml2YXRlIG5vcm1hbGl6ZVVybFNlcnZpY2U6IE5vcm1hbGl6ZVVybFNlcnZpY2UsXG4gICAgQEluamVjdChFTUJFRERFRF9EQVRBX1NFUlZJQ0VfQ09ORklHX1RPS0VOKVxuICAgIEBPcHRpb25hbCgpXG4gICAgcHJpdmF0ZSBzZXJ2aWNlQ29uZmlnOiBFbWJlZGRlZERhdGFTZXJ2aWNlQ29uZmlnLFxuICAgIEBJbmplY3QoRE9DVU1FTlQpIHByaXZhdGUgZG9jdW1lbnQ6IGFueSxcbiAgKSB7XG4gICAgdGhpcy5maW5kUm9vdEVsZW1lbnQodGhpcy5kb2N1bWVudCwgdGhpcy5zZXJ2aWNlQ29uZmlnKTtcbiAgICBpZiAoZG9jdW1lbnQgJiYgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50ICYmIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5sYW5nKSB7XG4gICAgICB0aGlzLl9kb2N1bWVudExvY2FsZSA9IHBhcnNlTG9jYWxlKGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5sYW5nKTtcbiAgICB9XG5cbiAgICBpZiAoc2VydmljZUNvbmZpZykge1xuICAgICAgT2JqZWN0LmFzc2lnbih0aGlzLl9zZXJ2aWNlQ29uZmlnLCBzZXJ2aWNlQ29uZmlnKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGZpbmRSb290RWxlbWVudChfZG9jdW1lbnQ6IGFueSwgc2VydmljZUNvbmZpZzogRW1iZWRkZWREYXRhU2VydmljZUNvbmZpZykge1xuICAgIGlmIChzZXJ2aWNlQ29uZmlnICYmIHNlcnZpY2VDb25maWcucm9vdEVsZW1lbnRUYWdOYW1lKSB7XG4gICAgICBjb25zdCBuYXRpdmVFbGVtZW50ID0gX2RvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKHNlcnZpY2VDb25maWcucm9vdEVsZW1lbnRUYWdOYW1lKTtcbiAgICAgIGlmIChuYXRpdmVFbGVtZW50ICYmIG5hdGl2ZUVsZW1lbnQubGVuZ3RoID09PSAxKSB7XG4gICAgICAgIHRoaXMuX3Jvb3RFbGVtZW50ID0gbmF0aXZlRWxlbWVudFswXTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgIH1cbiAgICB0aHJvdyBuZXcgRXJyb3IoJ0VtYmVkZGVkRGF0YVNlcnZpY2U6IFJvb3QgZWxlbWVudCBvZiBhcHAgY291bGQgbm90IGJlIGZvdW5kIScpO1xuICB9XG5cbiAgcHJpdmF0ZSBwYXJzZUF0dHJpYnV0ZShuYW1lOiBzdHJpbmcpOiBhbnkge1xuICAgIGlmICghdGhpcy5fcm9vdEVsZW1lbnQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignRW1iZWRkZWQgZGF0YSB3YXMgbm90IGluaXRpYWxpemVkIScpO1xuICAgIH1cbiAgICB0cnkge1xuICAgICAgY29uc3QgYXR0ckNvbnQgPSB0aGlzLl9yb290RWxlbWVudC5nZXRBdHRyaWJ1dGUobmFtZSk7XG4gICAgICBpZiAoYXR0ckNvbnQubGVuZ3RoID4gMCkge1xuICAgICAgICBjb25zdCBjb250ZW50ID0gSlNPTi5wYXJzZShhdHRyQ29udCk7XG4gICAgICAgIGlmICghaXNFbXB0eShjb250ZW50KSkge1xuICAgICAgICAgIHJldHVybiBjb250ZW50O1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgaWYgKCF0aGlzLl9zZXJ2aWNlQ29uZmlnLnByb2R1Y3Rpb24pIHtcbiAgICAgICAgY29uc29sZS5sb2coJ0Vycm9yIHBhcnNpbmcgZW1iZWRkZWQgZGF0YSBwb2ludDogJyArIG5hbWUpO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm47XG4gIH1cblxuICAvKipcbiAgICogQ2FhUyByZXNvbHV0aW9uIGxvZ2ljOlxuICAgKiAgICAxLiBJZiBDYWFTIGF0dHJpYnV0ZSB3YXMgcmVjZWl2ZWQsIHVzZSB0aGF0XG4gICAqICAgIDIuIElmIGluc3RhbmNlSWQgaW4gQ3VzdG9tIGNvbmZpZ3VyYXRpb24sIHRyeSBpbnN0YW5jZSBjb25maWdcbiAgICogICAgMy4gdHJ5IGdsb2JhbCBjb25maWdcbiAgICogQHBhcmFtIGxhbmdcbiAgICovXG4gIGdldENhYVNDb25maWd1cmF0aW9uKCk6IE9ic2VydmFibGU8Q0FBU19UPiB7XG4gICAgLy8gMS5cbiAgICBpZiAodGhpcy5DYWFzKSB7XG4gICAgICByZXR1cm4gb2YodGhpcy5DYWFzKTtcbiAgICB9XG5cbiAgICBsZXQgcmV0OiBPYnNlcnZhYmxlPG51bGwgfCBDQUFTX1Q+ID0gb2YobnVsbCk7XG5cbiAgICAvLyAyLlxuICAgIGlmICh0aGlzLkN1c3RvbUNvbmZpZ3VyYXRpb24uaW5zdGFuY2VJZCkge1xuICAgICAgcmV0ID0gcmV0LnBpcGUoXG4gICAgICAgIGNvbmNhdE1hcCgoKSA9PiB7XG4gICAgICAgICAgcmV0dXJuIDxPYnNlcnZhYmxlPENBQVNfVD4+KFxuICAgICAgICAgICAgdGhpcy5odHRwXG4gICAgICAgICAgICAgIC5nZXQoXG4gICAgICAgICAgICAgICAgdGhpcy5ub3JtYWxpemVVcmxTZXJ2aWNlLm5vcm1hbGl6ZVVybChcbiAgICAgICAgICAgICAgICAgIGAke3RoaXMuX3NlcnZpY2VDb25maWcuQXNzZXRzQmFzZVBhdGh9LyR7dGhpcy5DdXN0b21Db25maWd1cmF0aW9uLmluc3RhbmNlSWR9L2NvbmZpZy5qc29uYCxcbiAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgICAgIHsgd2l0aENyZWRlbnRpYWxzOiB0cnVlIH0sXG4gICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgLnBpcGUoKCkgPT4gb2YobnVsbCkpXG4gICAgICAgICAgKTtcbiAgICAgICAgfSksXG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIDMuXG4gICAgcmV0ID0gcmV0LnBpcGUoXG4gICAgICBjb25jYXRNYXAoKHByZXYpID0+IHtcbiAgICAgICAgaWYgKHByZXYgPT09IG51bGwpIHtcbiAgICAgICAgICByZXR1cm4gPE9ic2VydmFibGU8Q0FBU19UPj50aGlzLmh0dHAuZ2V0KFxuICAgICAgICAgICAgdGhpcy5ub3JtYWxpemVVcmxTZXJ2aWNlLm5vcm1hbGl6ZVVybChgJHt0aGlzLl9zZXJ2aWNlQ29uZmlnLkFzc2V0c0Jhc2VQYXRofS9jb25maWcuanNvbmApLFxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICB3aXRoQ3JlZGVudGlhbHM6IHRydWUsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmV0dXJuIG9mKHByZXYpO1xuICAgICAgICB9XG4gICAgICB9KSxcbiAgICApO1xuXG4gICAgcmV0dXJuIHJldDtcbiAgfVxufVxuXG5mdW5jdGlvbiBpc0VtcHR5KG9iaikge1xuICBmb3IgKGNvbnN0IHByb3AgaW4gb2JqKSB7XG4gICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChvYmosIHByb3ApKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICB9XG4gIHJldHVybiB0cnVlO1xufVxuXG5pbnRlcmZhY2UgTG9jYWxlIHtcbiAgbGFuZ3VhZ2U6IHN0cmluZztcbiAgdmFyaWFudD86IHN0cmluZztcbiAgY291bnRyeT86IHN0cmluZztcbiAgc2NyaXB0Pzogc3RyaW5nO1xuICBrZXl3b3JkOiBzdHJpbmc7XG59XG5cbi8vIGh0dHA6Ly91c2VyZ3VpZGUuaWN1LXByb2plY3Qub3JnL2xvY2FsZVxuZnVuY3Rpb24gcGFyc2VMb2NhbGUobG9jYWxlKTogTG9jYWxlIHtcbiAgaWYgKCFsb2NhbGUpIHtcbiAgICByZXR1cm4gdm9pZCAwO1xuICB9XG5cbiAgLy8gZXh0cmFjdCBrZXl3b3JkXG4gIGNvbnN0IHN0cmluZ0xvY2FsZSA9IFN0cmluZyhsb2NhbGUpO1xuICBjb25zdCBrZXl3b3JkUG9zID0gc3RyaW5nTG9jYWxlLmluZGV4T2YoJ0AnKTtcblxuICBjb25zdCBrZXl3b3JkID0ga2V5d29yZFBvcyAhPT0gLTEgPyBzdHJpbmdMb2NhbGUuc3Vic3RyKGtleXdvcmRQb3MgKyAxKSA6IHZvaWQgMDtcblxuICBjb25zdCBsb2NhbGVXaXRob3V0S2V5d29yZCA9IGtleXdvcmRQb3MgIT09IC0xID8gc3RyaW5nTG9jYWxlLnN1YnN0cigwLCBrZXl3b3JkUG9zKSA6IHN0cmluZ0xvY2FsZTtcblxuICAvLyBlbi11cyA9PiBlbl91c1xuICBjb25zdCBwYXJ0cyA9IFN0cmluZyhsb2NhbGVXaXRob3V0S2V5d29yZCkucmVwbGFjZSgvLS9nLCAnXycpLnNwbGl0KCdfJyk7XG5cbiAgaWYgKCFwYXJ0cy5sZW5ndGggfHwgcGFydHMubGVuZ3RoID4gNCkge1xuICAgIHJldHVybiB2b2lkIDA7XG4gIH1cblxuICBjb25zdCBsYW5ndWFnZSA9IHBhcnRzLnNoaWZ0KCk7XG4gIGlmICghbGFuZ3VhZ2UpIHtcbiAgICByZXR1cm4gdm9pZCAwO1xuICB9XG5cbiAgY29uc3QgcmV0VmFyOiBMb2NhbGUgPSB7XG4gICAga2V5d29yZCxcbiAgICBsYW5ndWFnZTogbGFuZ3VhZ2UudG9Mb3dlckNhc2UoKSxcbiAgfTtcblxuICBpZiAoIXBhcnRzLmxlbmd0aCkge1xuICAgIHJldHVybiByZXRWYXI7XG4gIH1cblxuICBpZiAocGFydHMubGVuZ3RoID09PSAzKSB7XG4gICAgY29uc3QgdmFyaWFudCA9IHBhcnRzLnBvcCgpO1xuICAgIGlmICh2YXJpYW50KSB7XG4gICAgICByZXRWYXIudmFyaWFudCA9IHZhcmlhbnQudG9VcHBlckNhc2UoKTtcbiAgICB9XG4gIH1cblxuICBsZXQgY291bnRyeSA9IHBhcnRzLnBvcCgpO1xuICBpZiAoY291bnRyeS5sZW5ndGggPiAzKSB7XG4gICAgcmV0VmFyLmtleXdvcmQgPSBjb3VudHJ5O1xuXG4gICAgY291bnRyeSA9IHBhcnRzLnBvcCgpO1xuICB9XG5cbiAgaWYgKGNvdW50cnkpIHtcbiAgICByZXRWYXIuY291bnRyeSA9IGNvdW50cnkudG9VcHBlckNhc2UoKTtcbiAgfVxuXG4gIGlmICghcGFydHMubGVuZ3RoKSB7XG4gICAgcmV0dXJuIHJldFZhcjtcbiAgfVxuXG4gIGNvbnN0IHNjcmlwdCA9IHBhcnRzLnBvcCgpO1xuICBpZiAoc2NyaXB0KSB7XG4gICAgLy8gY2FwaXRhbGl6ZSBpdC5cbiAgICByZXRWYXIuc2NyaXB0ID0gc2NyaXB0LnN1YnN0cigwLCAxKS50b1VwcGVyQ2FzZSgpICsgc2NyaXB0LnN1YnN0cigxKS50b0xvd2VyQ2FzZSgpO1xuICB9XG5cbiAgcmV0dXJuIHJldFZhcjtcbn1cbiJdfQ==